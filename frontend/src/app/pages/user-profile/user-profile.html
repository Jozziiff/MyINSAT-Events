<section class="user-profile-page" [@staggerCards]>
  <!-- Loading State -->
  @if (loading()) {
    <div class="loading-container">
      <div class="loading-spinner"></div>
      <p>Loading user profile...</p>
    </div>
  } @else if (error()) {
    <div class="error-container glass-card">
      <svg class="error-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="8" x2="12" y2="12"></line>
        <line x1="12" y1="16" x2="12.01" y2="16"></line>
      </svg>
      <p>{{ error() }}</p>
      <button class="retry-btn" (click)="goBack()">Go Back</button>
    </div>
  } @else if (profile(); as user) {
    <!-- Back Button -->
    <div class="nav-bar">
      <button class="back-btn" (click)="goBack()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
        Back
      </button>
    </div>

    <!-- Profile Header -->
    <div class="profile-header-wrapper glass-card animate-card" [@fadeInUp]>
      <div class="profile-header">
        <div class="avatar-section">
          <div class="avatar-wrapper">
            @if (user.avatarUrl) {
              <img [src]="user.avatarUrl" alt="Profile avatar" class="avatar" />
            } @else {
              <div class="avatar avatar-placeholder">
                {{ user.fullName.charAt(0).toUpperCase() }}
              </div>
            }
          </div>
        </div>

        <div class="profile-info">
          <h1 class="profile-name">{{ user.fullName }}</h1>
          @if (user.studentYear) {
            <span class="profile-year">{{ user.studentYear }}</span>
          }
          @if (user.bio) {
            <p class="profile-bio">{{ user.bio }}</p>
          } @else {
            <p class="profile-bio profile-bio--empty">No bio available</p>
          }
          <span class="member-since">Member since {{ user.createdAt | date:'MMMM yyyy' }}</span>
        </div>
      </div>
    </div>

    <!-- Stats Row -->
    <div class="stats-row animate-card" [@fadeInUp]>
      <div class="stat-card glass-card">
        <div class="stat-icon stat-icon--success">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
        </div>
        <div class="stat-content">
          <span class="stat-label">Events Attended</span>
          <span class="stat-value">{{ stats().eventsAttended }}</span>
        </div>
      </div>
      <div class="stat-card glass-card">
        <div class="stat-icon stat-icon--primary">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
        </div>
        <div class="stat-content">
          <span class="stat-label">Upcoming Events</span>
          <span class="stat-value">{{ stats().eventsUpcoming }}</span>
        </div>
      </div>
      <div class="stat-card glass-card">
        <div class="stat-icon stat-icon--accent">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
          </svg>
        </div>
        <div class="stat-content">
          <span class="stat-label">Clubs Followed</span>
          <span class="stat-value">{{ stats().clubsFollowed }}</span>
        </div>
      </div>
      <div class="stat-card glass-card">
        <div class="stat-icon stat-icon--warning">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
          </svg>
        </div>
        <div class="stat-content">
          <span class="stat-label">Ratings Given</span>
          <span class="stat-value">{{ stats().ratingsGiven }}</span>
        </div>
      </div>
    </div>

    <!-- Main Content Grid -->
    <div class="profile-content-grid">
      <!-- Left Column - Events -->
      <div class="profile-events">
        <div class="section-card glass-card animate-card" [@fadeInUp]>
          <div class="section-header">
            <h2 class="section-title">
              <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
              </svg>
              Events
            </h2>
            <a routerLink="/events" class="view-all-link">Discover More ‚Üí</a>
          </div>

          <!-- Search and Controls -->
          <div class="events-controls">
            <div class="search-wrapper-profile">
              <span class="search-icon">üîç</span>
              <input
                type="text"
                placeholder="Search events..."
                [ngModel]="searchQuery()"
                (ngModelChange)="searchQuery.set($event)"
              >
            </div>

            <div class="controls-actions">
              <!-- Filter Dropdown -->
              <div class="filter-dropdown" [class.open]="showFilterDropdown()">
                <button class="filter-button" (click)="showFilterDropdown.set(!showFilterDropdown())">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                  </svg>
                  <span>{{ currentFilterLabel }}</span>
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="chevron">
                    <polyline points="6 9 12 15 18 9"></polyline>
                  </svg>
                </button>

                @if (showFilterDropdown()) {
                  <div class="filter-menu">
                    @for (option of filterOptions; track option.value) {
                      <button
                        class="filter-option"
                        [class.active]="selectedFilter() === option.value"
                        (click)="applyFilter(option.value)">
                        <span class="option-label">{{ option.label }}</span>
                        @if (selectedFilter() === option.value) {
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="check-icon">
                            <polyline points="20 6 9 17 4 12"></polyline>
                          </svg>
                        }
                      </button>
                    }
                  </div>
                }
              </div>

              <!-- Sort Dropdown -->
              <div class="sort-dropdown" [class.open]="showSortDropdown()">
                <button class="sort-button" (click)="showSortDropdown.set(!showSortDropdown())">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 6h18M7 12h10M11 18h2"></path>
                  </svg>
                  <span>{{ currentSortLabel }}</span>
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="chevron">
                    <polyline points="6 9 12 15 18 9"></polyline>
                  </svg>
                </button>

                @if (showSortDropdown()) {
                  <div class="sort-menu">
                    @for (option of sortOptions; track option.value) {
                      <button
                        class="sort-option"
                        [class.active]="selectedSort() === option.value"
                        (click)="applySort(option.value)">
                        <span class="option-icon">{{ option.icon }}</span>
                        <span class="option-label">{{ option.label }}</span>
                        @if (selectedSort() === option.value) {
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="check-icon">
                            <polyline points="20 6 9 17 4 12"></polyline>
                          </svg>
                        }
                      </button>
                    }
                  </div>
                }
              </div>
            </div>
          </div>

          <!-- Events List -->
          @if (filteredEvents().length > 0) {
            <div class="events-list">
              @for (event of filteredEvents(); track event.id) {
                <a [routerLink]="['/events', event.id]" class="event-card">
                  <div class="event-image-wrapper">
                    @if (event.photoUrl) {
                      <img [src]="event.photoUrl" [alt]="event.title" class="event-image">
                    } @else {
                      <div class="event-image-placeholder">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                          <line x1="16" y1="2" x2="16" y2="6"></line>
                          <line x1="8" y1="2" x2="8" y2="6"></line>
                          <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                      </div>
                    }
                  </div>
                  <div class="event-content">
                    <div class="event-header-row">
                      <h3 class="event-title">{{ event.title }}</h3>
                      <!-- Event Time Status Badge -->
                      @if (isEventLive(event.startTime, event.endTime)) {
                        <span class="event-time-badge live">
                          <span class="live-dot"></span>
                          {{ formatRemainingTime(getTimeUntilEnds(event.endTime)) }}
                        </span>
                      } @else if (isEventUpcoming(event.startTime) && getTimeUntil(event.startTime)) {
                        <span class="event-time-badge upcoming"
                              [class.urgent]="getTimeUntil(event.startTime)!.unit === 'hours' || (getTimeUntil(event.startTime)!.unit === 'days' && getTimeUntil(event.startTime)!.value <= 1)"
                              [class.very-urgent]="getTimeUntil(event.startTime)!.unit === 'minutes'">
                          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                          </svg>
                          {{ formatCountdown(getTimeUntil(event.startTime)) }}
                        </span>
                      } @else if (isEventPast(event.endTime)) {
                        <span class="event-time-badge ended">Ended</span>
                      }
                    </div>
                    <p class="event-club">{{ event.clubName }}</p>
                    <div class="event-meta">
                      <span class="event-date">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                          <line x1="16" y1="2" x2="16" y2="6"></line>
                          <line x1="8" y1="2" x2="8" y2="6"></line>
                          <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                        {{ event.startTime | date:'MMM d, yyyy' }}
                      </span>
                      <span class="event-status" [ngClass]="getStatusClass(event.registrationStatus)">
                        {{ getStatusLabel(event.registrationStatus) }}
                      </span>
                    </div>
                  </div>
                </a>
              }
            </div>
          } @else {
            <div class="empty-section">
              <svg class="empty-section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
              </svg>
              <p>No events found</p>
            </div>
          }
        </div>

        <!-- Ratings Section -->
        @if (userRatings().length > 0 || ratingsLoading()) {
          <div class="section-card glass-card animate-card" [@fadeInUp]>
            <div class="section-header">
              <h2 class="section-title">
                <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                </svg>
                Ratings
              </h2>
            </div>
            @if (ratingsLoading()) {
              <div class="loading-ratings">
                <div class="spinner-small"></div>
                <p>Loading ratings...</p>
              </div>
            } @else if (userRatings().length > 0) {
              <div class="ratings-list">
                @for (rating of displayedRatings(); track rating.id) {
                  <div class="rating-card" [routerLink]="['/events', rating.eventId]">
                    <div class="rating-header">
                      <span class="event-title-rating">{{ rating.eventTitle }}</span>
                      <div class="rating-stars">
                        @for (star of [1,2,3,4,5]; track star) {
                          <svg class="star-icon" [class.filled]="star <= rating.rating" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                          </svg>
                        }
                      </div>
                    </div>
                    @if (rating.comment) {
                      <p class="rating-comment">"{{ rating.comment }}"</p>
                    }
                    <span class="rating-date">{{ rating.createdAt | date:'mediumDate' }}</span>
                  </div>
                }
              </div>
              @if (userRatings().length > 3) {
                <button class="show-more-btn" (click)="toggleShowAllRatings()">
                  {{ showAllRatings() ? 'Show Less' : 'Show All (' + userRatings().length + ')' }}
                </button>
              }
            }
          </div>
        }
      </div>

      <!-- Right Column - Clubs -->
      <div class="profile-sidebar">
        <!-- Managed Clubs -->
        @if (user.managedClubs.length > 0) {
          <div class="section-card glass-card animate-card" [@fadeInUp]>
            <div class="section-header">
              <h2 class="section-title">
                <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                </svg>
                Managed Clubs
              </h2>
            </div>
            <div class="clubs-list">
              @for (club of user.managedClubs; track club.id) {
                <a [routerLink]="['/clubs', club.id]" class="club-card">
                  <div class="club-logo">
                    @if (club.logoUrl) {
                      <img [src]="club.logoUrl" [alt]="club.name">
                    } @else {
                      <div class="club-logo-placeholder">
                        {{ club.name.charAt(0).toUpperCase() }}
                      </div>
                    }
                  </div>
                  <div class="club-info">
                    <h3 class="club-name">{{ club.name }}</h3>
                    @if (club.shortDescription) {
                      <p class="club-desc">{{ club.shortDescription }}</p>
                    }
                  </div>
                  <span class="manager-badge">Manager</span>
                </a>
              }
            </div>
          </div>
        }

        <!-- Followed Clubs -->
        <div class="section-card glass-card animate-card" [@fadeInUp]>
          <div class="section-header">
            <h2 class="section-title">
              <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
              </svg>
              Following
            </h2>
          </div>
          @if (user.followedClubs.length > 0) {
            <div class="clubs-list">
              @for (club of user.followedClubs; track club.id) {
                <a [routerLink]="['/clubs', club.id]" class="club-card">
                  <div class="club-logo">
                    @if (club.logoUrl) {
                      <img [src]="club.logoUrl" [alt]="club.name">
                    } @else {
                      <div class="club-logo-placeholder">
                        {{ club.name.charAt(0).toUpperCase() }}
                      </div>
                    }
                  </div>
                  <div class="club-info">
                    <h3 class="club-name">{{ club.name }}</h3>
                    @if (club.shortDescription) {
                      <p class="club-desc">{{ club.shortDescription }}</p>
                    }
                  </div>
                </a>
              }
            </div>
          } @else {
            <div class="empty-section">
              <svg class="empty-section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
              </svg>
              <p>Not following any clubs yet</p>
            </div>
          }
        </div>
      </div>
    </div>
  }
</section>
