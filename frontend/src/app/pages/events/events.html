<div class="page-container container" @fadeSlideIn>
  <header class="page-header">
    <div class="text-content">
      <h1>Discover Events</h1>
      <p>Browse the latest workshops, parties, and gatherings at INSAT.</p>
    </div>

    <div class="controls">
      <div class="search-wrapper">
        <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
        <input
          type="text"
          placeholder="Search events..."
          [ngModel]="searchQuery()"
          (ngModelChange)="searchQuery.set($event)"
        >
      </div>

      <div class="controls-actions">
        <!-- Filter Dropdown -->
        <div class="filter-dropdown" [class.open]="showFilterDropdown()">
          <button class="filter-button" (click)="showFilterDropdown.set(!showFilterDropdown())">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
            </svg>
            <span>{{ currentFilterLabel }}</span>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="chevron">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>

          @if (showFilterDropdown()) {
            <div class="filter-menu">
              @for (option of filterOptions; track option.value) {
                <button
                  class="filter-option"
                  [class.active]="selectedFilter() === option.value"
                  [class.live]="option.value === 'live'"
                  (click)="applyFilter(option.value)">
                  <span class="option-icon" [innerHTML]="option.icon"></span>
                  <span class="option-label">{{ option.label }}</span>
                  @if (selectedFilter() === option.value) {
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="check-icon">
                      <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                  }
                </button>
              }
            </div>
          }
        </div>

        <!-- Sort Dropdown -->
        <div class="sort-dropdown" [class.open]="showSortDropdown()">
          <button class="sort-button" (click)="showSortDropdown.set(!showSortDropdown())">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 6h18M7 12h10M11 18h2"></path>
            </svg>
            <span>{{ currentSortLabel }}</span>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="chevron">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>

          @if (showSortDropdown()) {
            <div class="sort-menu">
              @for (option of sortOptions; track option.value) {
                <button
                  class="sort-option"
                [class.active]="selectedSort() === option.value"
                (click)="applySort(option.value)">
                <span class="option-icon" [innerHTML]="option.icon"></span>
                <span class="option-label">{{ option.label }}</span>
                @if (selectedSort() === option.value) {
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="check-icon">
                    <polyline points="20 6 9 17 4 12"></polyline>
                  </svg>
                }
              </button>
            }
          </div>
        }
      </div>
      </div>
    </div>
  </header>

  <!-- Loading state -->
  @if (loading()) {
    <div class="loading-state">
      <div class="loading-spinner"></div>
      <p>Loading events...</p>
    </div>
  }

  <!-- Error state -->
  @if (error()) {
    <div class="error-state">
      <p>{{ error() }}</p>
      <button class="btn-outline" (click)="loadEvents()">Try Again</button>
    </div>
  }

  <!-- Events Grid -->
  @if (!loading() && !error()) {
    <div class="event-grid">
      @for (event of filteredEvents(); track event.id) {
        <div class="event-card" [class.event-ended]="isEventEnded(event)" [class.event-live]="isEventLive(event)" (click)="navigateToEvent(event.id)">
          <!-- Event Image -->
          @if (event.photoUrl) {
            <div class="card-image">
              <img [src]="event.photoUrl" [alt]="event.title" />
              <div class="image-overlay"></div>
              @if (isRejected(event)) {
                <div class="rejected-overlay">
                  <div class="rejected-badge">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                      <circle cx="12" cy="12" r="10"></circle>
                      <line x1="15" y1="9" x2="9" y2="15"></line>
                      <line x1="9" y1="9" x2="15" y2="15"></line>
                    </svg>
                    <span>Registration Rejected</span>
                  </div>
                </div>
              } @else if (isEventEnded(event)) {
                <div class="ended-overlay">
                  <div class="ended-badge">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"></circle>
                      <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                    <span>Event Ended</span>
                  </div>
                </div>
              } @else if (isEventLive(event)) {
                <div class="live-overlay">
                  <div class="live-badge">
                    <span class="live-dot"></span>
                    <span>Live Now</span>
                  </div>
                </div>
              }
            </div>
          }

          <div class="card-header">
            <div class="header-left">
              <!-- Club Logo -->
              @if (event.club?.logoUrl) {
                <img class="club-logo" [src]="event.club?.logoUrl" [alt]="event.club?.name" />
              }
              <span class="price-tag">{{ formatPrice(event.price) }}</span>
            </div>

            <!-- Countdown, Live, or Rating Badge -->
            @if (isEventLive(event)) {
              <div class="live-badge-small pulsing">
                <span class="live-dot"></span>
                <span>{{ formatRemainingTime(getTimeUntilEventEnds(event)) }}</span>
              </div>
            } @else if (!isEventEnded(event) && getTimeUntilEvent(event)) {
              <div class="countdown-badge"
                   [class.urgent]="getTimeUntilEvent(event)!.unit === 'hours' || (getTimeUntilEvent(event)!.unit === 'days' && getTimeUntilEvent(event)!.value <= 1)"
                   [class.very-urgent]="getTimeUntilEvent(event)!.unit === 'minutes'">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                <span>{{ formatCountdown(getTimeUntilEvent(event)) }}</span>
              </div>
            } @else {
              <!-- Rating Badge -->
              <div class="rating-badge" [class.new-event]="event.stats.ratingCount === 0">
                @if (event.stats.ratingCount > 0) {
                  <svg class="star-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                  </svg>
                  <span>{{ formatRating(event.stats.averageRating) }}</span>
                  <span class="rating-count">({{ event.stats.ratingCount }})</span>
                } @else {
                  <span>New</span>
                }
              </div>
            }
          </div>

          <div class="card-body">
            <h3>{{ event.title }}</h3>
            <p class="club-name">by {{ event.club?.name || 'Unknown Club' }}</p>

            <div class="meta-info">
              <span class="meta-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="16" y1="2" x2="16" y2="6"></line>
                  <line x1="8" y1="2" x2="8" y2="6"></line>
                  <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                {{ formatDate(event.startTime) }}
              </span>
              @if (event.location) {
                <span class="meta-item">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                    <circle cx="12" cy="10" r="3"></circle>
                  </svg>
                  {{ event.location }}
                </span>
              }
            </div>

            <!-- Stats Row -->
            <div class="stats-row">
              <div class="stat">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                </svg>
                <span>{{ event.stats.interestedCount }}</span>
              </div>
              <div class="stat">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                  <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
                <span>{{ event.stats.confirmedCount }}</span>
              </div>
              @if (event.stats.attendedCount > 0) {
                <div class="stat attended">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                  </svg>
                  <span>{{ event.stats.attendedCount }}</span>
                </div>
              }
            </div>
          </div>

          <div class="card-footer">
            <!-- Interest Button -->
            <button
              class="btn-interest"
              [class.interested]="isInterested(event)"
              [class.confirmed]="isConfirmed(event)"
              [class.pending]="isPendingPayment(event)"
              [class.rejected]="isRejected(event)"
              [class.attended]="isAttended(event)"
              [class.processing]="isProcessing(event.id)"
              (click)="toggleInterest(event, $event)"
              [disabled]="isProcessing(event.id) || isEventEnded(event) || isEventLive(event) || isRejected(event) || isConfirmed(event) || isPendingPayment(event) || isAttended(event)"
            >
              @if (isProcessing(event.id)) {
                <div class="btn-spinner"></div>
              } @else if (isRejected(event)) {
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="15" y1="9" x2="9" y2="15"></line>
                  <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
                Rejected
              } @else if (isConfirmed(event)) {
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                Confirmed
              } @else if (isPendingPayment(event)) {
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                Pending Payment
              } @else if (isAttended(event)) {
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                  <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
                Attended
              } @else if (isInterested(event)) {
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                </svg>
                Interested
              } @else {
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                </svg>
                Interested
              }
            </button>

            <!-- View Details Button -->
            <button class="btn-icon" (click)="navigateToEvent(event.id)">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M5 12h14M12 5l7 7-7 7"/>
              </svg>
            </button>
          </div>
        </div>
      } @empty {
        <div class="empty-state">
          <p>No events found matching your search.</p>
        </div>
      }
    </div>
  }
</div>
