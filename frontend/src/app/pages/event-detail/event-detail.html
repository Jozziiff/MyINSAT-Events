<div class="page-container" @fadeSlideIn>
    <!-- Header with Back Button -->
    <header class="event-header">
        <button type="button" class="btn-back" (click)="goBack()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7" />
            </svg>
            Back to Events
        </button>
    </header>

    @if (loading()) {
    <div class="loading-container">
        <div class="spinner"></div>
        <p>Loading event...</p>
    </div>
    } @else if (error()) {
    <div class="error-container">
        <div class="error-icon">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
        </div>
        <p>{{ error() }}</p>
        <button type="button" class="btn-back-main" (click)="goBack()">Back to Events</button>
    </div>
    } @else if (event()) {
    <div class="event-detail">
        <!-- Hero Section -->
        <div class="hero-section" [class.no-image]="!event()!.photoUrl">
            @if (event()!.photoUrl) {
            <img [src]="event()!.photoUrl" [alt]="event()!.title" class="hero-image">
            <div class="hero-overlay"></div>
            }
            <div class="hero-content">
                <div class="hero-left">
                    <h1 class="event-title">{{ event()!.title }}</h1>

                    <!-- Countdown/Live Badge -->
                    <div class="event-time-badge">
                    @if (isUpcoming() && getTimeUntil()) {
                        <span class="countdown-badge"
                              [class.urgent]="getTimeUntil()!.unit === 'hours' || (getTimeUntil()!.unit === 'days' && getTimeUntil()!.value <= 1)"
                              [class.very-urgent]="getTimeUntil()!.unit === 'minutes'">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                            {{ formatCountdown(getTimeUntil()) }}
                        </span>
                    } @else if (isLive()) {
                        <span class="live-badge pulsing">
                            <span class="live-dot"></span>
                            {{ formatRemainingTime(getTimeUntilEventEnds()) }}
                        </span>
                    } @else if (isPast()) {
                        <span class="ended-badge">
                            Event Ended
                        </span>
                    }
                </div>

                <!-- Event Stats Pills -->
                <div class="event-stats-pills">
                    @if (event()!.stats.averageRating > 0) {
                    <span class="stat-pill rating">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                            <polygon
                                points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
                        </svg>
                        {{ event()!.stats.averageRating.toFixed(1) }}
                    </span>
                    }
                    <span class="stat-pill interested">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path
                                d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" />
                        </svg>
                        {{ event()!.stats.interestedCount }} interested
                    </span>
                    <span class="stat-pill confirmed">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <polyline points="20 6 9 17 4 12" />
                        </svg>
                        {{ event()!.stats.confirmedCount }} going
                    </span>
                </div>
            </div>

            <!-- Rating Section (for attended events) -->
            @if (hasAttended() && isLoggedIn()) {
                <div class="hero-rating">
                    <button type="button" class="rating-button" (click)="openRatingModal()">
                        <div class="rating-stars">
                            @for (star of [1,2,3,4,5]; track star) {
                                <svg class="star-icon"
                                     [class.filled]="star <= currentUserRating()"
                                     viewBox="0 0 24 24"
                                     [attr.fill]="star <= currentUserRating() ? 'currentColor' : 'none'"
                                     stroke="currentColor"
                                     stroke-width="2">
                                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                                </svg>
                            }
                        </div>
                        <span class="rating-text">
                            {{ currentUserRating() > 0 ? 'Update Rating' : 'Rate Event' }}
                        </span>
                    </button>
                </div>
            }
        </div>

        <!-- Rating Modal -->
        @if (showRatingModal()) {
            <div class="rating-modal-overlay" (click)="closeRatingModal()">
                <div class="rating-modal" (click)="$event.stopPropagation()">
                    <div class="modal-header">
                        <h3>Rate this Event</h3>
                        <button type="button" class="modal-close" (click)="closeRatingModal()">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="modal-stars">
                            @for (star of [1,2,3,4,5]; track star) {
                                <button type="button"
                                        class="star-button"
                                        (click)="setRating(star)"
                                        (mouseenter)="setHoverRating(star)"
                                        (mouseleave)="setHoverRating(0)">
                                    <svg class="star-icon-large"
                                         [class.filled]="star <= (hoverRating() || selectedRating())"
                                         viewBox="0 0 24 24"
                                         [attr.fill]="star <= (hoverRating() || selectedRating()) ? 'currentColor' : 'none'"
                                         stroke="currentColor"
                                         stroke-width="1.5">
                                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                                    </svg>
                                </button>
                            }
                        </div>
                        <p class="rating-label">
                            {{ selectedRating() > 0 ? selectedRating() + ' out of 5 stars' : 'Select a rating' }}
                        </p>
                        <textarea
                            class="rating-comment"
                            placeholder="Add a comment (optional)"
                            rows="3"
                            [(ngModel)]="ratingComment"
                        ></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-cancel" (click)="closeRatingModal()">Cancel</button>
                        <button type="button"
                                class="btn-submit"
                                (click)="submitRating()"
                                [disabled]="selectedRating() === 0 || ratingLoading()">
                            {{ ratingLoading() ? 'Submitting...' : 'Submit Rating' }}
                        </button>
                    </div>
                </div>
            </div>
        }
    </div>

    <div class="event-content">
            <!-- Two Column Layout -->
            <div class="event-layout">
                <!-- Main Content -->
                <div class="event-main">
                    <!-- Hosted By Section -->
                    @if (event()!.club) {
                    <div class="hosted-by-card glass-card">
                        <div class="hosted-by-header">
                            <span class="hosted-label">Hosted by</span>
                        </div>
                        <div class="hosted-by-content">
                            <a [routerLink]="['/clubs', event()!.club!.id]" class="club-link">
                                <div class="club-logo-wrapper">
                                    @if (event()!.club!.logoUrl) {
                                    <img [src]="event()!.club!.logoUrl" [alt]="event()!.club!.name" class="club-logo">
                                    } @else {
                                    <div class="club-logo club-logo-placeholder">
                                        {{ event()!.club!.name.charAt(0).toUpperCase() }}
                                    </div>
                                    }
                                </div>
                                <div class="club-info">
                                    <span class="club-name">{{ event()!.club!.name }}</span>
                                    <span class="view-club">View club profile â†’</span>
                                </div>
                            </a>
                            @if (isLoggedIn()) {
                            <button class="follow-btn" [class.following]="isFollowingClub()"
                                [disabled]="followLoading()" (click)="toggleFollowClub()">
                                @if (followLoading()) {
                                <span class="btn-spinner"></span>
                                } @else if (isFollowingClub()) {
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <polyline points="20 6 9 17 4 12" />
                                </svg>
                                Following
                                } @else {
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                                Follow
                                }
                            </button>
                            }
                        </div>
                    </div>
                    }

                    <!-- Event Description -->
                    @if (event()!.description) {
                    <div class="event-description glass-card">
                        <h2>
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                                <polyline points="14 2 14 8 20 8" />
                                <line x1="16" y1="13" x2="8" y2="13" />
                                <line x1="16" y1="17" x2="8" y2="17" />
                            </svg>
                            About This Event
                        </h2>
                        <p>{{ event()!.description }}</p>
                    </div>
                    }

                    <!-- Sections -->
                    @if (sections().length > 0) {
                    <div class="event-sections">
                        @for (section of sections(); let i = $index; track i) {
                        <div class="section-block glass-card" [class.image-left]="i % 2 === 0"
                            [class.image-right]="i % 2 === 1">
                            <div class="section-text">
                                <h3>{{ section.title }}</h3>
                                <p>{{ section.description }}</p>
                            </div>
                            @if (section.imageUrl) {
                            <div class="section-image">
                                <img [src]="section.imageUrl" [alt]="section.title" class="section-img">
                            </div>
                            }
                        </div>
                        }
                    </div>
                    }

                    <!-- Event Ratings Section (for ended events) -->
                    @if (isPast() && (eventRatings().length > 0 || ratingsLoading())) {
                    <div class="event-ratings-section glass-card">
                        <div class="section-header">
                            <h2>
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                                </svg>
                                Event Ratings
                            </h2>
                            @if (event()!.stats.ratingCount > 0) {
                            <div class="ratings-summary">
                                <span class="average-rating">{{ event()!.stats.averageRating.toFixed(1) }}</span>
                                <div class="rating-stars-display">
                                    @for (star of [1,2,3,4,5]; track star) {
                                    <svg class="star-icon" [class.filled]="star <= event()!.stats.averageRating" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                                    </svg>
                                    }
                                </div>
                                <span class="rating-count">({{ event()!.stats.ratingCount }} {{ event()!.stats.ratingCount === 1 ? 'rating' : 'ratings' }})</span>
                            </div>
                            }
                        </div>

                        @if (ratingsLoading()) {
                        <div class="ratings-loading">
                            <div class="spinner"></div>
                            <p>Loading ratings...</p>
                        </div>
                        } @else if (eventRatings().length > 0) {
                        <div class="ratings-list">
                            @for (rating of displayedRatings(); track rating.id) {
                            <div class="rating-card">
                                <div class="rating-card-header">
                                    <a [routerLink]="['/users', rating.user?.id]" class="user-info user-info-link">
                                        @if (rating.user?.avatarUrl) {
                                        <img [src]="rating.user?.avatarUrl" [alt]="rating.user?.fullName" class="user-avatar">
                                        } @else {
                                        <div class="user-avatar user-avatar-placeholder">
                                            {{ rating.user?.fullName?.charAt(0)?.toUpperCase() || '?' }}
                                        </div>
                                        }
                                        <div class="user-details">
                                            <span class="user-name">{{ rating.user?.fullName || 'Anonymous' }}</span>
                                            <span class="rating-date">{{ rating.createdAt | date:'mediumDate' }}</span>
                                        </div>
                                    </a>
                                    <div class="rating-stars">
                                        @for (star of [1,2,3,4,5]; track star) {
                                        <svg class="star-icon" [class.filled]="star <= rating.rating" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                                        </svg>
                                        }
                                    </div>
                                </div>
                                @if (rating.comment) {
                                <p class="rating-comment">"{{ rating.comment }}"</p>
                                }
                            </div>
                            }
                        </div>
                        @if (eventRatings().length > 3) {
                        <button type="button" class="show-more-btn" (click)="toggleShowAllRatings()">
                            {{ showAllRatings() ? 'Show Less' : 'Show All (' + eventRatings().length + ')' }}
                        </button>
                        }
                        } @else {
                        <p class="no-ratings">No ratings yet for this event.</p>
                        }
                    </div>
                    }
                </div>

                <!-- Sidebar -->
                <aside class="event-sidebar">
                    <!-- Registration Card -->
                    <div class="registration-card glass-card">
                        <h3>Event Details</h3>

                        <div class="detail-row">
                            <div class="detail-icon">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                    <line x1="16" y1="2" x2="16" y2="6"></line>
                                    <line x1="8" y1="2" x2="8" y2="6"></line>
                                    <line x1="3" y1="10" x2="21" y2="10"></line>
                                </svg>
                            </div>
                            <div class="detail-content">
                                <span class="detail-label">Date</span>
                                <span class="detail-value">{{ formatDate(event()!.startTime) }}</span>
                            </div>
                        </div>

                        <div class="detail-row">
                            <div class="detail-icon">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <polyline points="12 6 12 12 16 14"></polyline>
                                </svg>
                            </div>
                            <div class="detail-content">
                                <span class="detail-label">Time</span>
                                <span class="detail-value">{{ formatTime(event()!.startTime) }} - {{
                                    formatTime(event()!.endTime) }}</span>
                            </div>
                        </div>

                        <div class="detail-row">
                            <div class="detail-icon">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                    <circle cx="12" cy="10" r="3"></circle>
                                </svg>
                            </div>
                            <div class="detail-content">
                                <span class="detail-label">Location</span>
                                <span class="detail-value">{{ event()!.location || 'TBA' }}</span>
                            </div>
                        </div>

                        @if (event()!.capacity) {
                        <div class="detail-row">
                            <div class="detail-icon">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="9" cy="7" r="4"></circle>
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                </svg>
                            </div>
                            <div class="detail-content">
                                <span class="detail-label">Capacity</span>
                                <span class="detail-value">{{ event()!.capacity }} people</span>
                            </div>
                        </div>
                        }

                        <div class="detail-row price-row">
                            <div class="detail-icon">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <line x1="12" y1="1" x2="12" y2="23"></line>
                                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                                </svg>
                            </div>
                            <div class="detail-content">
                                <span class="detail-label">Price</span>
                                <span class="detail-value price">{{ event()!.price ? formatPrice(event()!.price) :
                                    'Free' }}</span>
                            </div>
                        </div>

                        <!-- Registration Actions -->
                        @if (isLoggedIn() && isUpcoming()) {
                        <div class="registration-actions">
                            @if (userStatus(); as status) {
                            <!-- Show current status -->
                            @if (status === 'INTERESTED') {
                            <div class="current-status">
                                <span class="status-badge status-interested">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" />
                                    </svg>
                                    Interested
                                </span>
                            </div>

                            <!-- Remove Interest button -->
                            <button class="btn-secondary" (click)="toggleInterest()"
                                [disabled]="registrationLoading()">
                                @if (registrationLoading()) {
                                <span class="btn-spinner"></span>
                                } @else {
                                Remove Interest
                                }
                            </button>

                            <!-- Confirm attendance button (only when interested) -->
                            <button class="btn-confirm" (click)="confirmAttendance()"
                                [disabled]="registrationLoading()">
                                @if (registrationLoading()) {
                                <span class="btn-spinner"></span>
                                } @else {
                                Confirm Attendance
                                }
                            </button>
                            } @else if (status === 'CANCELLED') {
                            <!-- Show interest button again for cancelled registrations -->
                            <button class="btn-interested" (click)="toggleInterest()"
                                [disabled]="registrationLoading()">
                                @if (registrationLoading()) {
                                <span class="btn-spinner"></span>
                                } @else {
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path
                                        d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" />
                                </svg>
                                I'm Interested
                                }
                            </button>
                            } @else if (status === 'CONFIRMED' || status === 'PENDING_PAYMENT') {
                            <div class="current-status">
                                <span class="status-badge" [class]="'status-' + status.toLowerCase()">
                                    {{ getStatusLabel(status) }}
                                </span>
                            </div>
                            <!-- Cancel button for confirmed registrations -->
                            <button class="btn-cancel" (click)="cancelRegistration()"
                                [disabled]="registrationLoading()">
                                Cancel Registration
                            </button>
                            } @else {
                            <!-- Other statuses -->
                            <div class="current-status">
                                <span class="status-badge" [class]="'status-' + status.toLowerCase()">
                                    {{ getStatusLabel(status) }}
                                </span>
                            </div>
                            }
                            } @else {
                            <!-- No status - show only interested button -->
                            <button class="btn-interested" (click)="toggleInterest()"
                                [disabled]="registrationLoading()">
                                @if (registrationLoading()) {
                                <span class="btn-spinner"></span>
                                } @else {
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path
                                        d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" />
                                </svg>
                                I'm Interested
                                }
                            </button>
                            }
                        </div>
                        } @else if (!isLoggedIn()) {
                        <div class="login-prompt">
                            <p>Log in to register for this event</p>
                            <a routerLink="/login" class="btn-login">Log In</a>
                        </div>
                        } @else if (isLive()) {
                        <div class="live-event-notice">
                            <div class="status-display live">
                                <div class="live-icon-wrapper">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                        <circle cx="12" cy="12" r="8"></circle>
                                    </svg>
                                    <span class="live-pulse"></span>
                                </div>
                                <div class="status-text">
                                    <span class="status-label">{{ formatRemainingTime(getTimeUntilEventEnds()) }}</span>
                                    <p>This event is currently happening</p>
                                </div>
                            </div>
                        </div>
                        } @else if (isPast()) {
                        <div class="past-event-notice">
                            @if (userStatus() === 'ATTENDED') {
                                <div class="status-display attended">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                    </svg>
                                    <div class="status-text">
                                        <span class="status-label">You Attended</span>
                                        <p>Thanks for participating in this event!</p>
                                    </div>
                                </div>
                            } @else if (userStatus() === 'NO_SHOW') {
                                <div class="status-display not-attended">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <line x1="15" y1="9" x2="9" y2="15"></line>
                                        <line x1="9" y1="9" x2="15" y2="15"></line>
                                    </svg>
                                    <div class="status-text">
                                        <span class="status-label">Did Not Attend</span>
                                        <p>You were registered but didn't attend this event</p>
                                    </div>
                                </div>
                            } @else {
                                <div class="status-display ended">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <polyline points="12 6 12 12 16 14"></polyline>
                                    </svg>
                                    <div class="status-text">
                                        <span class="status-label">Event Ended</span>
                                        <p>This event has already taken place</p>
                                    </div>
                                </div>
                            }
                        </div>
                        }
                    </div>
                </aside>
            </div>
        </div>
    </div>
    }
</div>
