<div class="dashboard-layout" @fadeSlideIn>
    <!-- Sidebar for multiple clubs -->
    @if (hasMultipleClubs()) {
    <aside class="clubs-sidebar">
        <div class="sidebar-header">
            <h3>My Clubs</h3>
        </div>
        <nav class="clubs-list">
            @for (club of managedClubs(); track club.id) {
            <button 
                class="club-item" 
                [class.active]="selectedClubId() === club.id"
                (click)="selectClub(club.id)">
                @if (club.logoUrl) {
                <img [src]="club.logoUrl" alt="{{ club.name }}" class="club-logo" />
                } @else {
                <span class="club-initial">{{ club.name.charAt(0) }}</span>
                }
                <span class="club-name">{{ club.name }}</span>
            </button>
            }
        </nav>
    </aside>
    }

    <main class="page-container container" [class.with-sidebar]="hasMultipleClubs()">
        <header class="page-header">
            <div class="text-content">
                <h1>Manager Dashboard</h1>
                <p>Manage events for <strong>{{ clubName() }}</strong></p>
            </div>

            <div class="header-actions">
                <button class="btn-primary" [routerLink]="['/manager/clubs', selectedClubId(), 'events', 'new']">
                    Create Event
                </button>
                <button class="btn-outline" (click)="openManagersPopup()">
                    Manage Team
                </button>
            </div>
        </header>

    @if (loading()) {
    <div class="loading-state">
        <div class="spinner"></div>
        <p>Loading events...</p>
    </div>
    }

    @if (error()) {
    <div class="error-state">
        <p>{{ error() }}</p>
        <button class="btn-outline" (click)="loadData()">Retry</button>
    </div>
    }

    @if (!loading() && !error()) {
    <div class="stats-cards">
        <div class="stat-card">
            <div class="stat-value">{{ events().length }}</div>
            <div class="stat-label">Total Events</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ publishedCount() }}</div>
            <div class="stat-label">Published</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ draftCount() }}</div>
            <div class="stat-label">Drafts</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ joinRequests().length }}</div>
            <div class="stat-label">Pending Requests</div>
        </div>
    </div>

    @if (joinRequests().length > 0) {
    <div class="section-header">
        <h2>Join Requests ({{ joinRequests().length }})</h2>
    </div>
    <div class="join-requests-list">
        @for (request of joinRequests(); track request.id) {
        <div class="join-request-card">
            <div class="request-user">
                @if (request.user.avatarUrl) {
                <img [src]="request.user.avatarUrl" alt="Avatar" class="user-avatar" />
                } @else {
                <div class="user-avatar-placeholder">{{ request.user.fullName.charAt(0) }}</div>
                }
                <div class="user-info">
                    <span class="user-name">{{ request.user.fullName }}</span>
                    <span class="user-email">{{ request.user.email }}</span>
                </div>
            </div>
            <div class="request-date">
                {{ formatDate(request.createdAt.toString()) }}
            </div>
            <div class="request-actions">
                <button class="btn-approve" (click)="approveRequest(request)">Approve</button>
                <button class="btn-reject" (click)="rejectRequest(request)">Reject</button>
            </div>
        </div>
        }
    </div>
    }

    @if (events().length === 0) {
    <div class="empty-state">
        <h3>No events yet</h3>
        <p>Create your first event to get started</p>
        <button class="btn-primary" [routerLink]="['/manager/clubs', selectedClubId(), 'events', 'new']">Create Event</button>
    </div>
    } @else {

    @if (upcomingEvents().length > 0) {
    <div class="section-header">
        <h2>Upcoming Events ({{ upcomingEvents().length }})</h2>
    </div>
    <div class="events-table">
        <table>
            <thead>
                <tr>
                    <th>Event</th>
                    <th>Date & Time</th>
                    <th>Location</th>
                    <th>Capacity</th>
                    <th>Price</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @for (event of upcomingEvents(); track event.id) {
                <tr>
                    <td>
                        <div class="event-title-cell">
                            <strong>{{ event.title }}</strong>
                            @if (event.description) {
                            <span class="event-desc">{{ event.description }}</span>
                            }
                        </div>
                    </td>
                    <td>
                        <div class="date-cell">
                            <span class="date">{{ formatDate(event.startTime) }}</span>
                            <span class="time">{{ formatTime(event.startTime) }}</span>
                        </div>
                    </td>
                    <td>{{ event.location }}</td>
                    <td>{{ event.capacity }}</td>
                    <td>{{ event.price ? event.price + ' TND' : 'Free' }}</td>
                    <td>
                        <span class="status-pill" [class]="getStatusClass(event.status)">
                            {{ event.status }}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-icon" title="View" (click)="viewEvent(event.id)">View</button>
                            @if (event.status === 'DRAFT') {
                            <button class="btn-icon" title="Publish" (click)="publishEvent(event)">Publish</button>
                            }
                            @if (event.status === 'PUBLISHED') {
                            <button class="btn-icon" title="View Registrations"
                                (click)="viewRegistrations(event.id)">Registrations</button>
                            }
                            <button class="btn-icon" title="Edit" (click)="editEvent(event.id)">Edit</button>
                            <button class="btn-icon btn-danger" title="Delete"
                                (click)="deleteEvent(event)">Delete</button>
                        </div>
                    </td>
                </tr>
                }
            </tbody>
        </table>
    </div>
    }

    @if (pastEvents().length > 0) {
    <div class="section-header">
        <h2>Past Events ({{ pastEvents().length }})</h2>
    </div>
    <div class="events-table past-events">
        <table>
            <thead>
                <tr>
                    <th>Event</th>
                    <th>Date & Time</th>
                    <th>Location</th>
                    <th>Capacity</th>
                    <th>Price</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @for (event of pastEvents(); track event.id) {
                <tr class="past-event-row">
                    <td>
                        <div class="event-title-cell">
                            <strong>{{ event.title }}</strong>
                            @if (event.description) {
                            <span class="event-desc">{{ event.description }}</span>
                            }
                        </div>
                    </td>
                    <td>
                        <div class="date-cell">
                            <span class="date">{{ formatDate(event.startTime) }}</span>
                            <span class="time">{{ formatTime(event.startTime) }}</span>
                        </div>
                    </td>
                    <td>{{ event.location }}</td>
                    <td>{{ event.capacity }}</td>
                    <td>{{ event.price ? event.price + ' TND' : 'Free' }}</td>
                    <td>
                        <span class="status-pill" [class]="getStatusClass(event.status)">
                            {{ event.status }}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-icon" title="View" (click)="viewEvent(event.id)">View</button>
                            @if (event.status === 'PUBLISHED') {
                            <button class="btn-icon" title="View Registrations"
                                (click)="viewRegistrations(event.id)">Registrations</button>
                            }
                            <button class="btn-icon btn-danger" title="Delete"
                                (click)="deleteEvent(event)">Delete</button>
                        </div>
                    </td>
                </tr>
                }
            </tbody>
        </table>
    </div>
    }
    }
    }
    </main>
</div>

<!-- Managers Popup -->
@if (showManagersPopup()) {
<div class="popup-overlay" (click)="closeManagersPopup()">
    <div class="popup-content" (click)="$event.stopPropagation()">
        <div class="popup-header">
            <h2>Club Managers</h2>
            <button class="popup-close" (click)="closeManagersPopup()">&times;</button>
        </div>
        
        <div class="popup-body">
            @if (loadingManagers()) {
            <div class="popup-loading">
                <div class="spinner"></div>
                <p>Loading managers...</p>
            </div>
            } @else if (clubManagers().length === 0) {
            <p class="no-managers">No managers found for this club.</p>
            } @else {
            <div class="managers-list">
                @for (manager of clubManagers(); track manager.id) {
                <div class="manager-card">
                    <div class="manager-info">
                        @if (manager.avatarUrl) {
                        <img [src]="manager.avatarUrl" alt="Avatar" class="manager-avatar" />
                        } @else {
                        <div class="manager-avatar-placeholder">{{ (manager.fullName && manager.fullName.charAt(0)) || 'M' }}</div>
                        }
                        <div class="manager-details">
                            <span class="manager-name">{{ manager.fullName || 'Unknown' }}</span>
                            <span class="manager-email">{{ manager.email }}</span>
                        </div>
                    </div>
                    @if (clubManagers().length > 1) {
                    <button class="btn-remove" (click)="removeManager(manager)" title="Remove manager">
                        Remove
                    </button>
                    }
                </div>
                }
            </div>
            }
        </div>
    </div>
</div>
}