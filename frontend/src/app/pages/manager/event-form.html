<div class="create-event-layout" @fadeSlideIn>
  <!-- Left Side: Form -->
  <aside class="form-panel">
    <header class="panel-header">
      <a routerLink="/manager" class="btn-back">Back to Dashboard</a>
      <h1>{{ isEditMode() ? 'Edit Event' : 'Create New Event' }}</h1>
      <p>{{ isEditMode() ? 'Update your event details' : 'Fill out the form to see the live preview' }}</p>
    </header>

    @if (loading()) {
      <div class="loading-state">
        <div class="spinner"></div>
        <p>Loading event data...</p>
      </div>
    } @else if (success()) {
      <div class="success-message">
        <span class="success-icon">‚úì</span>
        <p>Event {{ isEditMode() ? 'updated' : 'created' }} successfully! Redirecting...</p>
      </div>
    } @else {
      <form class="event-form" (ngSubmit)="onSubmit()">
        @if (error()) {
          <div class="error-message">
            <p>{{ error() }}</p>
          </div>
        }

        <!-- Basic Information Section -->
        <section class="form-section">
          <h2>Event Information <span class="required-badge">Required</span></h2>

          <div class="form-group">
            <label for="title">Event Title *</label>
            <input
              type="text"
              id="title"
              [(ngModel)]="title"
              name="title"
              placeholder="e.g., Tech Workshop 2026"
              required
              minlength="3"
            >
          </div>

          <div class="form-group">
            <label for="description">Description</label>
            <textarea
              id="description"
              [(ngModel)]="description"
              name="description"
              placeholder="Brief description of your event..."
              rows="4"
            ></textarea>
          </div>

          <div class="form-group">
            <label for="location">Location *</label>
            <input
              type="text"
              id="location"
              [(ngModel)]="location"
              name="location"
              placeholder="e.g., INSAT Amphitheater"
              required
            >
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="startTime">Start Time *</label>
              <input
                type="datetime-local"
                id="startTime"
                [(ngModel)]="startTime"
                name="startTime"
                [min]="getMinStartTime()"
                (change)="onStartTimeChange()"
                required
              >
              <small class="hint">Event cannot start in the past</small>
            </div>

            <div class="form-group">
              <label for="endTime">End Time *</label>
              <input
                type="datetime-local"
                id="endTime"
                [(ngModel)]="endTime"
                name="endTime"
                [min]="minEndTime || startTime"
                [disabled]="!startTime"
                required
              >
              <small class="hint">Auto-set to 1 hour after start</small>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="capacity">Capacity *</label>
              <input
                type="number"
                id="capacity"
                [(ngModel)]="capacity"
                name="capacity"
                placeholder="30"
                min="1"
                required
              >
            </div>

            <div class="form-group">
              <label for="price">Price (DT)</label>
              <input
                type="number"
                id="price"
                [(ngModel)]="price"
                name="price"
                placeholder="0"
                min="0"
                step="0.5"
              >
              <small class="hint">Leave 0 for free events</small>
            </div>
          </div>
        </section>

        <!-- Cover Image Section -->
        <section class="form-section">
          <h2>Event Cover Image</h2>

          <div class="image-upload-group">
            <label>Cover Image (recommended)</label>
            <div class="upload-row">
              <div class="file-upload wide">
                <input
                  type="file"
                  accept="image/*"
                  (change)="onFileSelected($event, 'cover')"
                  id="coverFile"
                >
                <label for="coverFile" class="upload-btn wide">
                  @if (coverPreview) {
                    <img [src]="coverPreview" alt="Cover preview" class="preview-thumb wide">
                  } @else {
                    <span>+</span>
                  }
                </label>
              </div>
              <span class="or-divider">or</span>
              <input
                type="url"
                [(ngModel)]="coverUrl"
                name="coverUrl"
                placeholder="https://example.com/event-cover.jpg"
                class="url-input"
              >
            </div>
          </div>
        </section>

        <!-- Optional Sections -->
        <section class="form-section">
          <h2>Additional Content</h2>
          <p class="section-hint">Toggle sections to add more details to your event page.</p>

          @for (key of getSectionKeys(); track key) {
            <div class="optional-section" [class.enabled]="sections[key].enabled">
              <div class="section-toggle">
                <label class="toggle-switch">
                  <input type="checkbox" [(ngModel)]="sections[key].enabled" [name]="key + 'Enabled'">
                  <span class="slider"></span>
                </label>
                <span class="toggle-label">{{ getSectionLabel(key) }}</span>
              </div>

              @if (sections[key].enabled) {
                <div class="section-fields" @fadeSlideIn>
                  <div class="form-group">
                    <label>Title</label>
                    <input
                      type="text"
                      [(ngModel)]="sections[key].title"
                      [name]="key + 'Title'"
                      [placeholder]="'e.g., ' + getSectionLabel(key)"
                    >
                  </div>

                  <div class="form-group">
                    <label>Content</label>
                    <textarea
                      [(ngModel)]="sections[key].description"
                      [name]="key + 'Content'"
                      placeholder="Write about this section..."
                      rows="3"
                    ></textarea>
                  </div>

                  <div class="image-upload-group compact">
                    <label>Image (optional)</label>
                    <div class="upload-row">
                      <div class="file-upload small">
                        <input
                          type="file"
                          accept="image/*"
                          (change)="onFileSelected($event, key)"
                          [id]="key + 'File'"
                        >
                        <label [for]="key + 'File'" class="upload-btn small">
                          @if (sections[key].imagePreview) {
                            <img [src]="sections[key].imagePreview" alt="Preview" class="preview-thumb small">
                          } @else {
                            <span>+</span>
                          }
                        </label>
                      </div>
                      <span class="or-divider">or</span>
                      <input
                        type="url"
                        [(ngModel)]="sections[key].imageUrl"
                        [name]="key + 'ImageUrl'"
                        placeholder="Image URL"
                        class="url-input"
                      >
                    </div>
                  </div>
                </div>
              }
            </div>
          }
        </section>

        <!-- Submit -->
        <div class="form-actions">
          <a routerLink="/manager" class="btn-cancel">Cancel</a>
          <button type="submit" class="btn-submit" [disabled]="submitting()">
            @if (submitting()) {
              <span class="spinner"></span> {{ isEditMode() ? 'Saving...' : 'Creating...' }}
            } @else {
              {{ isEditMode() ? 'Save Changes' : 'Create Event' }}
            }
          </button>
        </div>
      </form>
    }
  </aside>

  <!-- Right Side: Live Preview -->
  <main class="preview-panel">
    <div class="preview-label">
      <span class="preview-dot"></span>
      Live Preview
    </div>

    <div class="event-preview">
      <!-- Hero Section -->
      <header
        class="preview-hero"
        [style.backgroundImage]="getPreviewCover() ? 'url(' + getPreviewCover() + ')' : 'none'"
        [class.has-cover]="getPreviewCover()"
      >
        <div class="hero-overlay"></div>
        <div class="hero-content">
          <div class="event-badge">Event</div>
          <h1>{{ title || 'Your Event Title' }}</h1>
          <div class="event-meta">
            <div class="meta-item">
              <span class="icon">üìç</span>
              <span>{{ location || 'Location' }}</span>
            </div>
            @if (startTime) {
              <div class="meta-item">
                <span class="icon">üìÖ</span>
                <span>{{ formatDateForDisplay(startTime) }}</span>
              </div>
            }
            <div class="meta-item">
              <span class="icon">üë•</span>
              <span>{{ capacity || '30' }} spots</span>
            </div>
            <div class="meta-item price">
              <span class="icon">üí∞</span>
              <span>{{ getFormattedPrice() }}</span>
            </div>
          </div>
        </div>
      </header>

      <!-- Description Section -->
      @if (description) {
        <section class="preview-section description-section">
          <h2>About This Event</h2>
          <p class="preview-text">{{ description }}</p>
        </section>
      }

      <!-- Dynamic Sections -->
      @for (item of getEnabledSections(); track item.key; let i = $index) {
        <section class="preview-section">
          <div class="section-row" [class.reversed]="i % 2 === 0">
            <div class="section-image">
              <img [src]="item.imagePreview || item.imageUrl || getDefaultImageForSection(item.key)" [alt]="item.title">
            </div>
            <div class="section-content">
              <h2>{{ item.title || getSectionLabel(item.key) }}</h2>
              <p class="preview-text" [class.placeholder]="!item.description">
                {{ item.description || 'Content for this section will appear here...' }}
              </p>
            </div>
          </div>
        </section>
      }

      <!-- Empty State -->
      @if (!hasAnyContent()) {
        <div class="empty-preview">
          <p>Start filling the form to see your event page come to life!</p>
        </div>
      }
    </div>
  </main>
</div>
